package bnbclient

import (
	"encoding/json"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/rawdb"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/trie"
	"testing"
)

func TestReceiptsHashCalculate(t *testing.T) {
	receiptsJsonStr := `[{"blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","blockNumber":"0x2922a8e","contractAddress":null,"cumulativeGasUsed":"0xa6e2","effectiveGasPrice":"0x2540be400","from":"0x643abe5dac11d8908e1b1939df109e4da21e5c1c","gasUsed":"0xa6e2","logs":[{"address":"0x7d899d26f2e94ffcd4b440c3008b0c6befcd3cca","topics":["0x2a08a2bd2798f0aae9a843f0f4ad4de488c1b3d5f04049940cfed736ad69fb97","0x0000000000000000000000000000000000000000000000000000000000000002","0x000000000000000000000000643abe5dac11d8908e1b1939df109e4da21e5c1c"],"data":"0x00000000000000000000000038bc38bd824b6ee87571f9d3cfbe6d6e28e3dc62b343d9da40c04c22a6c085555c5c245f94cb8cd80761ab8694de1cb4c197fc7a0000000000000000000000000000000000000000000000000000000000000001","blockNumber":"0x2922a8e","transactionHash":"0x027cdd9293560d1a2fda0373b3fba30f1e9e74b290bb3c984ae12afc88e38f84","transactionIndex":"0x0","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","logIndex":"0x0","removed":false},{"address":"0x7d899d26f2e94ffcd4b440c3008b0c6befcd3cca","topics":["0x8257378aa73bf8e4ada848713526584a3dcee0fd3db3beed7397f7a7f5067cc9","0x0000000000000000000000000000000000000000000000000000000000000002"],"data":"0x00000000000000000000000038bc38bd824b6ee87571f9d3cfbe6d6e28e3dc62b343d9da40c04c22a6c085555c5c245f94cb8cd80761ab8694de1cb4c197fc7a0000000000000000000000000000000000000000000000000000000000000002","blockNumber":"0x2922a8e","transactionHash":"0x027cdd9293560d1a2fda0373b3fba30f1e9e74b290bb3c984ae12afc88e38f84","transactionIndex":"0x0","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","logIndex":"0x1","removed":false}],"logsBloom":"0x04000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000004000000000000000000000000000000000000000000000008000000000000000000200000000000000000100000000000000000000000000000000000000000000000000000000004000000000000000000000004000000000000000004000000000000000020001000000000000000000000000008000000008000000000000","status":"0x1","to":"0x7d899d26f2e94ffcd4b440c3008b0c6befcd3cca","transactionHash":"0x027cdd9293560d1a2fda0373b3fba30f1e9e74b290bb3c984ae12afc88e38f84","transactionIndex":"0x0","type":"0x0"},{"blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","blockNumber":"0x2922a8e","contractAddress":null,"cumulativeGasUsed":"0xfaea","effectiveGasPrice":"0x147d35700","from":"0xa0ecab6c4b88094e133adb464e89ff7eafb0cdb3","gasUsed":"0x5408","logs":[],"logsBloom":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","status":"0x1","to":"0xa0ecab6c4b88094e133adb464e89ff7eafb0cdb3","transactionHash":"0x2bfd45c3a34c900c43eec9851c8c9b2dca55f100d06476981b6889ab1c7ef874","transactionIndex":"0x1","type":"0x2"},{"blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","blockNumber":"0x2922a8e","contractAddress":null,"cumulativeGasUsed":"0x2a30c","effectiveGasPrice":"0x12a05f200","from":"0x00e3cc76da72cf673e4429e2d527388956af61ef","gasUsed":"0x1a822","logs":[{"address":"0xecf0db7107b4e6d7a716b50a248b51d3e20482eb","topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef"],"data":"0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bf408b7091398153d74ea6dc089630d0ecce7593000000000000000000000000000000000000000000000000000000000003648e","blockNumber":"0x2922a8e","transactionHash":"0x0c6ed37439f838e362d2319e45b03378d5f2d595504ab6a21ab674ed7d597da6","transactionIndex":"0x2","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","logIndex":"0x2","removed":false},{"address":"0xdaa61d377f3beda5eb57478e52061f71a40a2c4a","topics":["0x08d6a38712c44625eade32110ef0f5f641ea140ed17be80e51fc6cc224e4d04d"],"data":"0x00000000000000000000000000000000000000000000000000000000000367f70000000000000000000000000000000000000000000000000000000000000040000000000000000000000000ecf0db7107b4e6d7a716b50a248b51d3e20482eb0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000bf408b7091398153d74ea6dc089630d0ecce7593000000000000000000000000000000000000000000000000000000000000006100000000000000000000000000000000000000000000000000000000000000646112e8ac000000000000000000000000bf408b7091398153d74ea6dc089630d0ecce7593000000000000000000000000000000000000000000000000000000000003648e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","blockNumber":"0x2922a8e","transactionHash":"0x0c6ed37439f838e362d2319e45b03378d5f2d595504ab6a21ab674ed7d597da6","transactionIndex":"0x2","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","logIndex":"0x3","removed":false}],"logsBloom":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002008000000000000000000008000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010800000000400000000000000000000000000000000000080000000000000000000000000000000000000000100000000000000000040000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000","status":"0x1","to":"0xdaa61d377f3beda5eb57478e52061f71a40a2c4a","transactionHash":"0x0c6ed37439f838e362d2319e45b03378d5f2d595504ab6a21ab674ed7d597da6","transactionIndex":"0x2","type":"0x0"},{"blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","blockNumber":"0x2922a8e","contractAddress":null,"cumulativeGasUsed":"0x2f514","effectiveGasPrice":"0x12a05f200","from":"0xaa25aa7a19f9c426e07dee59b12f944f4d9f1dd3","gasUsed":"0x5208","logs":[],"logsBloom":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","status":"0x1","to":"0x2622e50165898cd9d8829b985c93de39009fab96","transactionHash":"0x416c432e6f7dc74d5fd8fad569940842622ce7a356db0f85e5180af94ebd5687","transactionIndex":"0x3","type":"0x0"},{"blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","blockNumber":"0x2922a8e","contractAddress":null,"cumulativeGasUsed":"0x3e6d4","effectiveGasPrice":"0x12a05f200","from":"0x437733291f90c15f8960de4c2ef8ae7f21e7d570","gasUsed":"0xf1c0","logs":[{"address":"0x94fbdc8af9c3e242981d2257f3f1fb868eed2bc6","topics":["0xb045190548dadae679cfe9e337437613ca6dd73efdf984f75e56f152ccee22f0","0x000000000000000000000000437733291f90c15f8960de4c2ef8ae7f21e7d570","0x000000000000000000000000942e820393e01be78cf47432d4ab84611f27c4ba"],"data":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003fb87872543087c000000000000000000000000000000000000000000000008cfab429d4019242f","blockNumber":"0x2922a8e","transactionHash":"0x2cea868d64e398be08c516e649d7b54672205d66e97871391928ed60123e53c2","transactionIndex":"0x4","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","logIndex":"0x4","removed":false}],"logsBloom":"0x00000000000000000000000000000000000000000000000000000000000000000000080000020000010000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000001000000000000000100000000000000000000000000000000000000000000000000000000000000020000000001008000000000000000000000000","status":"0x1","to":"0x94fbdc8af9c3e242981d2257f3f1fb868eed2bc6","transactionHash":"0x2cea868d64e398be08c516e649d7b54672205d66e97871391928ed60123e53c2","transactionIndex":"0x4","type":"0x0"},{"blobGasPrice":"0x1","blobGasUsed":"0x20000","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","blockNumber":"0x2922a8e","contractAddress":null,"cumulativeGasUsed":"0x438dc","effectiveGasPrice":"0x12a05f200","from":"0x013fce36695321d32251e58bff33292c685da696","gasUsed":"0x5208","logs":[],"logsBloom":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","status":"0x1","to":"0xff00000000000000000000000000000000001715","transactionHash":"0x05f5627bfcb5650236f18ac305d887479b608f6c0942b0506a3bed2dbddf1702","transactionIndex":"0x5","type":"0x3"},{"blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","blockNumber":"0x2922a8e","contractAddress":null,"cumulativeGasUsed":"0x60156","effectiveGasPrice":"0xb33b2dc0","from":"0x86aac30e9e1ec13f42026d8ecfd1257283d9f8cf","gasUsed":"0x1c87a","logs":[{"address":"0x49ff00552ca23899ba9f814bcf7ed55bc5cdd9ce","topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x00000000000000000000000086aac30e9e1ec13f42026d8ecfd1257283d9f8cf","0x000000000000000000000000b5768f4aafbb968a3d4d38ca5602c2d465c7baee"],"data":"0x000000000000000000000000000000000000000000000000000000000000138e","blockNumber":"0x2922a8e","transactionHash":"0x4382adafc40241c1e541ef09b0dad423bd43f829355ee7efcce55b27c84560f2","transactionIndex":"0x6","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","logIndex":"0x5","removed":false},{"address":"0x2a45de58552f2c5e0597d1fbb8ec83f7e2ddba0d","topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x0000000000000000000000000000000000000000000000000000000000000000","0x00000000000000000000000086aac30e9e1ec13f42026d8ecfd1257283d9f8cf"],"data":"0x000000000000000000000000000000000000000000000000000000000000138e","blockNumber":"0x2922a8e","transactionHash":"0x4382adafc40241c1e541ef09b0dad423bd43f829355ee7efcce55b27c84560f2","transactionIndex":"0x6","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","logIndex":"0x6","removed":false},{"address":"0x9adb675bc89d9ec5d829709e85562b7c99658d59","topics":["0x65199e8f9cbc273da46a3e57ea48d1ba2ced8379e8f19785847bb3bf1f712dfe","0x000000000000000000000000000000000000000000000000000000000000000c","0x0000000000000000000000000000000000000000000000000000000000000007","0x00000000000000000000000086aac30e9e1ec13f42026d8ecfd1257283d9f8cf"],"data":"0x00000000000000000000000049ff00552ca23899ba9f814bcf7ed55bc5cdd9ce000000000000000000000000000000000000000000000000000000000000138e000000000000000000000000000000000000000000000000000000000000138e","blockNumber":"0x2922a8e","transactionHash":"0x4382adafc40241c1e541ef09b0dad423bd43f829355ee7efcce55b27c84560f2","transactionIndex":"0x6","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","logIndex":"0x7","removed":false}],"logsBloom":"0x00000000000000000000001000000200000002000000000000000000000000000000000000000200000000000000000000001000000000000000000000000080000020000000000000000008000000000000000000000800040000008004000000400000020008000000000802000800000000009000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000002000000000000000000000000000000100000000000000000000002000000000000000000000000000400000000000000000500000020200000000000000000000000000000000000000000000000000000000000000000","status":"0x1","to":"0x9adb675bc89d9ec5d829709e85562b7c99658d59","transactionHash":"0x4382adafc40241c1e541ef09b0dad423bd43f829355ee7efcce55b27c84560f2","transactionIndex":"0x6","type":"0x2"},{"blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","blockNumber":"0x2922a8e","contractAddress":null,"cumulativeGasUsed":"0x6f2e6","effectiveGasPrice":"0xb33b2dc0","from":"0x5acd91ddb6617fe106c20c54983edb091ca5d610","gasUsed":"0xf190","logs":[{"address":"0x94fbdc8af9c3e242981d2257f3f1fb868eed2bc6","topics":["0xb045190548dadae679cfe9e337437613ca6dd73efdf984f75e56f152ccee22f0","0x0000000000000000000000005acd91ddb6617fe106c20c54983edb091ca5d610","0x000000000000000000000000d0cdfa5b387633402549d04e97dfe34a87f0609b"],"data":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000853a0d2313c00000000000000000000000000000000000000000000000000126c24e67b78190000","blockNumber":"0x2922a8e","transactionHash":"0xf5f893953a9a0d339607bc9a5515e8eb274c02047f2087d256c486bff1feea0b","transactionIndex":"0x7","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","logIndex":"0x8","removed":false}],"logsBloom":"0x00000000000000000000000000000000000000000000000000000000000000000000080000020000000000000000001000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000100000000000000000000000000000000000000000000000000000000000000040000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000100000000000000000000000000000001000000000000000000000000000000000000000001000000000000000000000000000","status":"0x1","to":"0x94fbdc8af9c3e242981d2257f3f1fb868eed2bc6","transactionHash":"0xf5f893953a9a0d339607bc9a5515e8eb274c02047f2087d256c486bff1feea0b","transactionIndex":"0x7","type":"0x2"},{"blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","blockNumber":"0x2922a8e","contractAddress":null,"cumulativeGasUsed":"0x7e482","effectiveGasPrice":"0xad731380","from":"0x961fd974f61c66cc9aac3091aaa9ddbc7dd99b9a","gasUsed":"0xf19c","logs":[{"address":"0x94fbdc8af9c3e242981d2257f3f1fb868eed2bc6","topics":["0xb045190548dadae679cfe9e337437613ca6dd73efdf984f75e56f152ccee22f0","0x000000000000000000000000961fd974f61c66cc9aac3091aaa9ddbc7dd99b9a","0x000000000000000000000000bd011522e0ec5fa6ea24a87b62194f2f1fca9cac"],"data":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000429d069189e00000000000000000000000000000000000000000000000000093612733dbc0c8000","blockNumber":"0x2922a8e","transactionHash":"0x9d9598bcb009a9ad64f9bc915e115aac1e3947a4fce524ed4f1352c29f3f7176","transactionIndex":"0x8","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","logIndex":"0x9","removed":false}],"logsBloom":"0x00000000000000000000000000010000000000000000000000000000000000000000080000020000000000000000000000000000000000000000000000000000000000000000000010000000000006000000000000000000000000000000000200000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000001000000000000000100000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000","status":"0x1","to":"0x94fbdc8af9c3e242981d2257f3f1fb868eed2bc6","transactionHash":"0x9d9598bcb009a9ad64f9bc915e115aac1e3947a4fce524ed4f1352c29f3f7176","transactionIndex":"0x8","type":"0x2"},{"blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","blockNumber":"0x2922a8e","contractAddress":null,"cumulativeGasUsed":"0x8b48a","effectiveGasPrice":"0x0","from":"0x40d3256eb0babe89f0ea54edaa398513136612f5","gasUsed":"0xd008","logs":[{"address":"0x0000000000000000000000000000000000001002","topics":["0x6c98249d85d88c3753a04a22230f595e4dc8d3dc86c34af35deeeedc861b89db","0x0000000000000000000000000000000000000000000000000000000000001000"],"data":"0x0000000000000000000000000000000000000000000000000000842c1dc516f8","blockNumber":"0x2922a8e","transactionHash":"0xa9ec8e4972cb0e9fd9e754eaaa0cd895d292dc8eb0a88095cb0b7067f211deea","transactionIndex":"0x9","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","logIndex":"0xa","removed":false},{"address":"0x0000000000000000000000000000000000001000","topics":["0x6ecc855f9440a9282c90913bbc91619fd44f5ec0b462af28d127b116f130aa4d"],"data":"0x0000000000000000000000000000000000000000000000000000842c1dc516f8","blockNumber":"0x2922a8e","transactionHash":"0xa9ec8e4972cb0e9fd9e754eaaa0cd895d292dc8eb0a88095cb0b7067f211deea","transactionIndex":"0x9","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","logIndex":"0xb","removed":false},{"address":"0x0000000000000000000000000000000000001000","topics":["0x627059660ea01c4733a328effb2294d2f86905bf806da763a89cee254de8bee5"],"data":"0x0000000000000000000000000000000000000000000000000000d379c93b57f3","blockNumber":"0x2922a8e","transactionHash":"0xa9ec8e4972cb0e9fd9e754eaaa0cd895d292dc8eb0a88095cb0b7067f211deea","transactionIndex":"0x9","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","logIndex":"0xc","removed":false},{"address":"0x0000000000000000000000000000000000001000","topics":["0x93a090ecc682c002995fad3c85b30c5651d7fd29b0be5da9d784a3302aedc055","0x00000000000000000000000040d3256eb0babe89f0ea54edaa398513136612f5"],"data":"0x0000000000000000000000000000000000000000000000000006eb1bf5510095","blockNumber":"0x2922a8e","transactionHash":"0xa9ec8e4972cb0e9fd9e754eaaa0cd895d292dc8eb0a88095cb0b7067f211deea","transactionIndex":"0x9","blockHash":"0xc63a6cdcf1a557edf16728d0f5a24c89d10b43a8bc649d5fa801981b291c7a08","logIndex":"0xd","removed":false}],"logsBloom":"0x00000000000000000000004000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000200000000200000000000000002010000000000000000000000000000000080020000200000000000000004000080000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000020000000000000002008000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000104002000000000000000000000000010000040000010000008000000000004000000000000000","status":"0x1","to":"0x0000000000000000000000000000000000001000","transactionHash":"0xa9ec8e4972cb0e9fd9e754eaaa0cd895d292dc8eb0a88095cb0b7067f211deea","transactionIndex":"0x9","type":"0x0"}]`
	var receipts []*types.Receipt
	if err := json.Unmarshal([]byte(receiptsJsonStr), &receipts); err != nil {
		t.Fatal(err)
	}
	receiptRootHash := common.HexToHash("0x0a96e73ae56edff9014d93b617a44a89e0ac91ba5f4c502f2790ef1234002f4e")

	db := rawdb.NewMemoryDatabase()
	mpt := trie.NewStackTrie(db)
	receiptHash := types.DeriveSha(types.Receipts(receipts), mpt)
	if receiptHash != receiptRootHash {
		t.Errorf("receipt hash not match, expect: %s, got: %s", receiptHash.Hex(), receiptHash.Hex())
	}
}
